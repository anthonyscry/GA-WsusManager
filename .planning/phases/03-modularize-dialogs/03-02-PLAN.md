---
phase: 03-modularize-dialogs
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: ["Modules/WsusDialogs.psm1", "Scripts/WsusManagementGui.ps1"]
autonomous: true

must_haves:
  truths:
    - "Show-RestoreDialog works from module"
    - "Show-MaintenanceDialog works from module"
    - "Show-TransferDialog works from module"
    - "Main script no longer contains these 3 dialog function definitions"
  artifacts:
    - path: "Modules/WsusDialogs.psm1"
      provides: "Dialog module with 6 total dialogs"
      exports: ["Show-GrantSysadminDialog", "Show-ExportDialog", "Show-ImportDialog", "Show-RestoreDialog", "Show-MaintenanceDialog", "Show-TransferDialog"]
  key_links:
    - from: "Scripts/WsusManagementGui.ps1"
      to: "Modules/WsusDialogs.psm1"
      via: "Function calls with -OwnerWindow"
---

<objective>
Move 3 medium-complexity dialog functions (Restore, Maintenance, Transfer) from the main GUI script into the WsusDialogs module.

Purpose: Continue reducing main script size. These dialogs all follow the same pattern (return option hashtables) and need the same `-OwnerWindow` refactoring.
Output: WsusDialogs module expanded to 6 exported functions.
</objective>

<execution_context>
@Scripts/WsusManagementGui.ps1
@Modules/WsusDialogs.psm1
</execution_context>

<context>
@.planning/phases/03-modularize-dialogs/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move Show-RestoreDialog and Show-MaintenanceDialog</name>
  <files>Modules/WsusDialogs.psm1, Scripts/WsusManagementGui.ps1</files>
  <action>
    1. Cut `Show-RestoreDialog` function (~lines 1656-1814, ~158 lines) from main script.
       Refactor before pasting into module:
       - Add parameter: `param([System.Windows.Window]$OwnerWindow)`
       - Replace `$dlg.Owner = $script:window` with `if ($OwnerWindow) { $dlg.Owner = $OwnerWindow }`
       - Use module color variables where possible
       Paste into module.

    2. Cut `Show-MaintenanceDialog` function (~lines 1815-2039, ~224 lines) from main script.
       Same refactoring:
       - Add `-OwnerWindow` parameter
       - Replace `$script:window` owner assignment
       Paste into module.

    3. Update callers in main script (operations region) to pass `$script:window`:
       - `$opts = Show-RestoreDialog -OwnerWindow $script:window`
       - `$opts = Show-MaintenanceDialog -OwnerWindow $script:window`

    4. Update `Export-ModuleMember` to include these 2 new functions.
  </action>
  <verify>
    - `rg "function Show-RestoreDialog" Modules/WsusDialogs.psm1` shows function
    - `rg "function Show-MaintenanceDialog" Modules/WsusDialogs.psm1` shows function
    - `rg "function Show-RestoreDialog" Scripts/WsusManagementGui.ps1` returns nothing
    - `rg "function Show-MaintenanceDialog" Scripts/WsusManagementGui.ps1` returns nothing
  </verify>
  <done>Restore and Maintenance dialogs moved to module with -OwnerWindow parameter.</done>
</task>

<task type="auto">
  <name>Task 2: Move Show-TransferDialog</name>
  <files>Modules/WsusDialogs.psm1, Scripts/WsusManagementGui.ps1</files>
  <action>
    1. Cut `Show-TransferDialog` function (~lines 2341-2591, ~250 lines) from main script.
       Refactor:
       - Add parameter: `param([System.Windows.Window]$OwnerWindow)`
       - Replace `$dlg.Owner = $script:window` with `if ($OwnerWindow) { $dlg.Owner = $OwnerWindow }`
       - Use module color variables where possible
       Paste into module.

    2. Update caller in main script:
       - `$opts = Show-TransferDialog -OwnerWindow $script:window`

    3. Update `Export-ModuleMember` to include `Show-TransferDialog`.
       Final list: Show-GrantSysadminDialog, Show-ExportDialog, Show-ImportDialog, Show-RestoreDialog, Show-MaintenanceDialog, Show-TransferDialog
  </action>
  <verify>
    - `rg "function Show-TransferDialog" Modules/WsusDialogs.psm1` shows function
    - `rg "function Show-TransferDialog" Scripts/WsusManagementGui.ps1` returns nothing
    - `rg "Export-ModuleMember" Modules/WsusDialogs.psm1` lists all 6 functions
  </verify>
  <done>Transfer dialog moved. Module now has 6 dialog functions.</done>
</task>

</tasks>

<verification>
- Module exports exactly 6 functions
- Main script no longer defines Restore, Maintenance, or Transfer dialogs
- All callers pass -OwnerWindow parameter
- No `$script:window` references in module (should be `$OwnerWindow` only)
</verification>

<success_criteria>
- WsusDialogs.psm1 contains 6 dialog functions
- Main script reduced by additional ~634 lines
- All dialog return values unchanged (callers work without modification beyond -OwnerWindow)
</success_criteria>

<output>
After completion, create `.planning/phases/03-modularize-dialogs/03-02-SUMMARY.md`
</output>
