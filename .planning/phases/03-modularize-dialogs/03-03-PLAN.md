---
phase: 03-modularize-dialogs
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified: ["Modules/WsusDialogs.psm1", "Scripts/WsusManagementGui.ps1"]
autonomous: true

must_haves:
  truths:
    - "All 8 dialog functions live in WsusDialogs module"
    - "Show-ScheduleTaskDialog works from module (no $script: scope leaks)"
    - "Show-SettingsDialog returns values instead of modifying script-scope variables"
    - "Main script #region Dialogs is empty or removed"
    - "Main script is ~1,500 lines shorter than before Phase 03 started"
  artifacts:
    - path: "Modules/WsusDialogs.psm1"
      provides: "Complete dialog module"
      exports: ["Show-GrantSysadminDialog", "Show-ExportDialog", "Show-ImportDialog", "Show-RestoreDialog", "Show-MaintenanceDialog", "Show-TransferDialog", "Show-ScheduleTaskDialog", "Show-SettingsDialog"]
  key_links:
    - from: "Scripts/WsusManagementGui.ps1 (Settings click handler)"
      to: "Show-SettingsDialog"
      via: "Call with params, handle return value"
      pattern: "Show-SettingsDialog.*-OwnerWindow.*-ContentPath"
    - from: "Scripts/WsusManagementGui.ps1 (Schedule handler)"
      to: "Show-ScheduleTaskDialog"
      via: "Call with -OwnerWindow, receive result"
---

<objective>
Move the final 2 dialog functions (ScheduleTask and Settings) into the WsusDialogs module, completing the dialog extraction refactor.

Purpose: Complete Phase 03 — all dialog logic extracted, main script focused on app orchestration.
Output: WsusDialogs module with all 8 dialogs. Main script reduced by ~1,500 total lines.
</objective>

<execution_context>
@Scripts/WsusManagementGui.ps1
@Modules/WsusDialogs.psm1
</execution_context>

<context>
@.planning/phases/03-modularize-dialogs/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move Show-ScheduleTaskDialog (fix scope issues)</name>
  <files>Modules/WsusDialogs.psm1, Scripts/WsusManagementGui.ps1</files>
  <action>
    1. Cut `Show-ScheduleTaskDialog` function (~lines 2042-2338, ~296 lines) from main script.

    2. **Critical refactoring** before pasting into module:
       - Add parameter: `param([System.Windows.Window]$OwnerWindow)`
       - Replace `$dlg.Owner = $script:window` with `if ($OwnerWindow) { $dlg.Owner = $OwnerWindow }`
       - **FIX SCOPE BUG:** Replace all `$script:ScheduleDialogResult` with a local `$result` variable.
         The function currently uses `$script:ScheduleDialogResult` which would reference the MODULE's scope (not the caller's) — causing silent `$null` returns.
         Pattern: Initialize `$result = @{ Cancelled = $true; ... }` at function start.
         In event handlers that modify it, use `.GetNewClosure()` to capture the local `$result`.
         Return `$result` at the end.
       - Verify no other `$script:` references leak through. Search the function body for `$script:` — replace each with either a parameter or local variable.

    3. Paste refactored function into module.

    4. Update caller in main script:
       - `$opts = Show-ScheduleTaskDialog -OwnerWindow $script:window`

    5. Update `Export-ModuleMember` to include `Show-ScheduleTaskDialog`.
  </action>
  <verify>
    - `rg "\$script:" Modules/WsusDialogs.psm1` shows ONLY module-level color variables (BgDark, BgCard, etc.), NOT `$script:window` or `$script:ScheduleDialogResult`
    - `rg "function Show-ScheduleTaskDialog" Scripts/WsusManagementGui.ps1` returns nothing
    - `rg "Show-ScheduleTaskDialog" Scripts/WsusManagementGui.ps1` shows call with -OwnerWindow
  </verify>
  <done>ScheduleTask dialog moved to module with scope issues fixed. Returns local $result instead of $script:ScheduleDialogResult.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor and move Show-SettingsDialog, final cleanup</name>
  <files>Modules/WsusDialogs.psm1, Scripts/WsusManagementGui.ps1</files>
  <action>
    1. Cut `Show-SettingsDialog` function (~lines 2592-2671, ~79 lines) from main script.

    2. **Refactor to return values instead of modifying $script: vars:**
       - Add parameters: `param([System.Windows.Window]$OwnerWindow, [string]$ContentPath = "C:\WSUS", [string]$SqlInstance = ".\SQLEXPRESS")`
       - Initialize result: `$result = @{ Cancelled = $true; ContentPath = $ContentPath; SqlInstance = $SqlInstance }`
       - Populate text fields from parameters: `$txt1.Text = $ContentPath` and `$txt2.Text = $SqlInstance`
       - In the Save button click handler, instead of:
         ```
         $script:ContentPath = if($txt1.Text){$txt1.Text}else{"C:\WSUS"}
         $script:SqlInstance = if($txt2.Text){$txt2.Text}else{".\SQLEXPRESS"}
         Save-Settings
         Update-Dashboard
         ```
         Do:
         ```
         $result.ContentPath = if($txt1.Text){$txt1.Text}else{"C:\WSUS"}
         $result.SqlInstance = if($txt2.Text){$txt2.Text}else{".\SQLEXPRESS"}
         $result.Cancelled = $false
         $dlg.Close()
         ```
         Use `.GetNewClosure()` on the click handler to capture `$result`.
       - Return `$result` at end of function.

    3. Paste into module. Update `Export-ModuleMember` with all 8 functions.

    4. **Update the caller** in main script. The current call is just `Show-SettingsDialog` in a click handler (~line 3483). Replace with:
       ```powershell
       $controls.BtnSettings.Add_Click({
           $settingsResult = Show-SettingsDialog -OwnerWindow $script:window -ContentPath $script:ContentPath -SqlInstance $script:SqlInstance
           if (-not $settingsResult.Cancelled) {
               $script:ContentPath = $settingsResult.ContentPath
               $script:SqlInstance = $settingsResult.SqlInstance
               Save-Settings
               Update-Dashboard
           }
       })
       ```

    5. **Final cleanup:**
       - Remove the empty `#region Dialogs` / `#endregion` markers from main script (or leave them as comments noting dialogs moved to WsusDialogs.psm1)
       - Verify `Export-ModuleMember` lists all 8 functions:
         `Export-ModuleMember -Function Show-GrantSysadminDialog, Show-ExportDialog, Show-ImportDialog, Show-RestoreDialog, Show-MaintenanceDialog, Show-TransferDialog, Show-ScheduleTaskDialog, Show-SettingsDialog`

    6. **Run tests:** `Invoke-Pester -Path .\Tests -Output Minimal` to ensure nothing is broken.
  </action>
  <verify>
    - `rg "function Show-SettingsDialog" Modules/WsusDialogs.psm1` shows function
    - `rg "function Show-SettingsDialog" Scripts/WsusManagementGui.ps1` returns nothing
    - `rg "Export-ModuleMember" Modules/WsusDialogs.psm1` lists all 8 functions
    - `rg "function Show-" Scripts/WsusManagementGui.ps1` only shows Show-Panel and Show-Help (non-dialog functions)
    - `Invoke-Pester -Path .\Tests -Output Minimal` passes
  </verify>
  <done>All 8 dialogs moved to WsusDialogs.psm1. Settings dialog returns values. Main script reduced by ~1,500 lines. Tests pass.</done>
</task>

</tasks>

<verification>
- `Modules/WsusDialogs.psm1` exists and exports 8 functions
- `Scripts/WsusManagementGui.ps1` has NO `function Show-*Dialog` definitions (only Show-Panel and Show-Help remain)
- Main script is approximately 2,200-2,400 lines (down from ~3,800)
- No `$script:window` references in module (all use `$OwnerWindow` parameter)
- No `$script:ScheduleDialogResult` anywhere (replaced with local `$result`)
- `Invoke-Pester` passes
</verification>

<success_criteria>
- Complete dialog extraction: 8 functions in module, 0 dialog definitions in main script
- Main script reduced by ~1,500 lines
- All dialog behaviors unchanged (return same hashtable structures)
- Settings dialog properly refactored (returns values instead of side effects)
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-modularize-dialogs/03-03-SUMMARY.md`
</output>
