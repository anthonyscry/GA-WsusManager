---
phase: 03-modularize-dialogs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: ["Modules/WsusDialogs.psm1", "Scripts/WsusManagementGui.ps1"]
autonomous: true

must_haves:
  truths:
    - "WsusDialogs.psm1 module exists and loads without errors"
    - "Show-GrantSysadminDialog works from module (same behavior as before)"
    - "Show-ExportDialog and Show-ImportDialog work from module"
    - "Main script no longer contains these 3 dialog function definitions"
  artifacts:
    - path: "Modules/WsusDialogs.psm1"
      provides: "Dialog module with first 3 dialogs"
      exports: ["Show-GrantSysadminDialog", "Show-ExportDialog", "Show-ImportDialog"]
  key_links:
    - from: "Scripts/WsusManagementGui.ps1"
      to: "Modules/WsusDialogs.psm1"
      via: "Import-Module at startup"
      pattern: "Import-Module.*WsusDialogs"
---

<objective>
Create the WsusDialogs module and move the first 3 dialog functions out of the main GUI script.

Purpose: Begin reducing main script size (~3,800 lines) by extracting self-contained dialog functions into a reusable module.
Output: New `Modules/WsusDialogs.psm1` with 3 exported dialog functions.
</objective>

<execution_context>
@Scripts/WsusManagementGui.ps1
@Modules/WsusUtilities.psm1
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/01-interactive-terminal/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WsusDialogs module and move Show-GrantSysadminDialog</name>
  <files>Modules/WsusDialogs.psm1, Scripts/WsusManagementGui.ps1</files>
  <action>
    1. Create `Modules/WsusDialogs.psm1` with this boilerplate:
       - `Add-Type -AssemblyName PresentationFramework, PresentationCore, WindowsBase, System.Windows.Forms`
       - Dark theme color constants as module-level variables (reuse from main script):
         ```
         $script:BgDark = "#0D1117"
         $script:BgCard = "#161B22"
         $script:BgInput = "#21262D"
         $script:TextPrimary = "#E6EDF3"
         $script:TextSecondary = "#8B949E"
         $script:AccentBlue = "#58A6FF"
         $script:AccentGreen = "#238636"
         ```

    2. Cut `Show-GrantSysadminDialog` function (lines ~1172-1377) from main script.
       Paste into module. This function already takes `-OwnerWindow` parameter and returns a hashtable â€” no refactoring needed.

    3. Add module import to main script. Find the existing `Import-Module` for WsusUtilities (line ~1348) and add a similar block below it for WsusDialogs:
       ```powershell
       $dialogPaths = @(
           (Join-Path $script:ScriptRoot "Modules\WsusDialogs.psm1"),
           (Join-Path (Split-Path $script:ScriptRoot -Parent) "Modules\WsusDialogs.psm1")
       )
       foreach ($p in $dialogPaths) {
           if (Test-Path $p) {
               Import-Module $p -Force -DisableNameChecking
               break
           }
       }
       ```

    4. Add `Export-ModuleMember -Function Show-GrantSysadminDialog` at end of module.

    5. Verify the caller in main script still passes correct arguments (search for `Show-GrantSysadminDialog` calls).
  </action>
  <verify>
    - `Test-Path Modules/WsusDialogs.psm1` returns True
    - `rg "Show-GrantSysadminDialog" Modules/WsusDialogs.psm1` shows the function
    - `rg "function Show-GrantSysadminDialog" Scripts/WsusManagementGui.ps1` returns nothing (removed)
    - `rg "Show-GrantSysadminDialog" Scripts/WsusManagementGui.ps1` still shows the call site
  </verify>
  <done>Module created with Show-GrantSysadminDialog. Main script imports module and calls function.</done>
</task>

<task type="auto">
  <name>Task 2: Move Show-ExportDialog and Show-ImportDialog to module</name>
  <files>Modules/WsusDialogs.psm1, Scripts/WsusManagementGui.ps1</files>
  <action>
    1. Cut `Show-ExportDialog` function (lines ~1379-1517) from main script.
       Before pasting into module, refactor:
       - Add parameter: `param([System.Windows.Window]$OwnerWindow)`
       - Replace `$dlg.Owner = $script:window` with `if ($OwnerWindow) { $dlg.Owner = $OwnerWindow }`
       - Replace hardcoded color strings with module-level variables (e.g., `$script:BgDark` instead of `"#0D1117"`)
       Paste into module.

    2. Cut `Show-ImportDialog` function (lines ~1520-1653) from main script.
       Same refactoring:
       - Add `-OwnerWindow` parameter
       - Replace `$script:window` owner assignment
       - Use module color variables
       Paste into module.

    3. Update callers in main script to pass `$script:window`:
       - `Show-ExportDialog -OwnerWindow $script:window`
       - `Show-ImportDialog -OwnerWindow $script:window`
       Search for all call sites (likely in the operations region, around lines 2800+).

    4. Update `Export-ModuleMember` to include all 3 functions:
       ```
       Export-ModuleMember -Function Show-GrantSysadminDialog, Show-ExportDialog, Show-ImportDialog
       ```
  </action>
  <verify>
    - `rg "function Show-ExportDialog" Modules/WsusDialogs.psm1` shows function
    - `rg "function Show-ImportDialog" Modules/WsusDialogs.psm1` shows function
    - `rg "function Show-ExportDialog" Scripts/WsusManagementGui.ps1` returns nothing
    - `rg "function Show-ImportDialog" Scripts/WsusManagementGui.ps1` returns nothing
    - `rg "Show-ExportDialog" Scripts/WsusManagementGui.ps1` shows call with -OwnerWindow
  </verify>
  <done>Export and Import dialogs moved to module with -OwnerWindow parameter. Callers updated.</done>
</task>

</tasks>

<verification>
- Module file exists at `Modules/WsusDialogs.psm1`
- Module exports exactly 3 functions
- Main script no longer defines these 3 functions
- Main script imports WsusDialogs module at startup
- No `$script:window` references remain in the moved functions (replaced with `$OwnerWindow`)
</verification>

<success_criteria>
- WsusDialogs.psm1 created with 3 dialog functions
- Main script reduced by ~480 lines
- All dialog callers pass -OwnerWindow parameter
- Module imports cleanly (no errors on `Import-Module`)
</success_criteria>

<output>
After completion, create `.planning/phases/03-modularize-dialogs/03-01-SUMMARY.md`
</output>
